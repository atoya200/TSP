<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa TSP con Animación</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        #map {
            width: 100%;
            height: 100vh;
        }
    </style>
</head>

<body>
    <!-- Modal -->
    <div class="modal fade" id="myModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Información del Punto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="modal-body-content">
                    Contenido dinámico del punto.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const API_KEY = "5b3ce3597851110001cf6248eeb850562bc34d329aca00efb8694718";

        const waypoints = [
            [-30.4, -56.46667],
            [-30.9056, -55.55012],
            [-31.73333, -55.98333],
            [-32.37028, -54.1675],
            [-33.23333, -54.38333],
            [-34.48333, -54.33333],
            [-34.9, -54.95],
            [-34.37589, -55.23771],
            [-34.852, -56.183],
            [-34.52278, -56.27778],
            [-34.09556, -56.21417],
            [-33.38056, -56.52361],
            [-33.5165, -56.89957],
            [-34.3375, -56.71361],
            [-34.46262, -57.83976],
            [-33.25203, -58.03093],
            [-33.13278, -58.295],
            [-32.32139, -58.07556],
            [-31.38333, -57.96667],
            [-30.4, -56.46667]
        ];

        document.addEventListener("DOMContentLoaded", async function () {
            const map = L.map('map').setView(waypoints[0], 6);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '© OpenStreetMap'
            }).addTo(map);

            const busIcon = L.icon({
                iconUrl: 'bus.png',
                iconSize: [32, 32],
                iconAnchor: [16, 16]
            });

            const ruta = await obtenerRuta(waypoints[0], waypoints[1]);

            const busMarker = L.marker(ruta[0], { icon: busIcon }).addTo(map);


            for (let i = 0 ; i < waypoints.length - 1; i++) {
                const ruta = await obtenerRuta(waypoints[i], waypoints[i + 1]);
                if (ruta.length > 0) {
                    // Añadir marcador en el punto actual con un evento clic
                    const puntoIcono = L.divIcon({
                        className: 'punto-icono',
                        html: `<img src="base.png" 
                                 style="width: 24px; cursor: pointer;" 
                                 onclick="mostrarModal(${i})">`
                    });
                    L.marker(waypoints[i], { icon: puntoIcono }).addTo(map);

                    // Animar línea y mover el autobús
                    await animarLineaConBus(map, ruta, busMarker);
                }
                await delay(1000); // Pausa entre rutas
            }
        });

        // Función para obtener ruta entre dos puntos
        async function obtenerRuta(origen, destino) {
            const url = `https://api.openrouteservice.org/v2/directions/driving-car?api_key=${API_KEY}&start=${origen[1]},${origen[0]}&end=${destino[1]},${destino[0]}`;
            const response = await fetch(url);
            if (response.ok) {
                const data = await response.json();
                return data.features[0].geometry.coordinates.map(([lng, lat]) => [lat, lng]);
            } else {
                console.error("Error al obtener la ruta:", response.status);
                return [];
            }
        }

        // Función para animar una línea y mover el ícono del autobús
        function animarLineaConBus(map, coordinates, busMarker)  {
            return new Promise(resolve => {
                const polyline = L.polyline([], { color: 'red', weight: 5 }).addTo(map);


                let i = 0;

                function dibujarSegmento() {
                    if (i < coordinates.length) {
                        polyline.addLatLng(L.latLng(coordinates[i]));
                        busMarker.setLatLng(coordinates[i]); // Mover el marcador del autobús
                        i++;
                        setTimeout(dibujarSegmento, 5); // Velocidad de animación
                    } else {
                        // Pausa antes de pasar al siguiente segmento
                        setTimeout(resolve, 1000); // 1 segundo de pausa
                    }
                }
                dibujarSegmento();
            });
        }

        // Función para mostrar el modal con información dinámica
        function mostrarModal(indice) {
            const contenido = `Has seleccionado el punto ${indice + 1}.`;
            document.getElementById('modal-body-content').textContent = contenido;
            const myModal = new bootstrap.Modal(document.getElementById('myModal'));
            myModal.show();
        }

        // Función para pausar la ejecución
        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
    </script>
</body>

</html>