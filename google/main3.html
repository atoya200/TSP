<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa TSP con Animación</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
</head>

<body>
    <div id="map" style="width: 100%; height: 100vh;"></div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Inicializa el mapa centrado en la primera ubicación
            const map = L.map('map').setView([-32.37085, -57.85371], 7);

            // Agrega el tile layer de OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '© OpenStreetMap'
            }).addTo(map);

            // Lista de waypoints en el orden óptimo del TSP
            const waypoints = [
                [-34.94747, -54.93382],
                [-34.852, -56.183],
                [-33.791, -57.48824],
                [-33.50719, -57.80079],
                [-33.2524, -58.03047],
                [-33.39811, -58.32177],
                [-33.11651, -58.31067],
                [-32.37085, -57.85371],
                [-30.78716, -57.77577],
                [-30.90534, -55.55076],
                [-31.71694, -55.98111],
                [-32.15, -56.11667],
                [-32.81667, -56.51667],
                [-32.92254, -54.94447],
                [-33.2534, -54.41947],
                [-33.23333, -54.38333],
                [-32.94419, -53.9381],
                [-34.19871, -53.85919],
                [-34.79123, -54.91824],
                [-34.94747, -54.93382]
            ];

            // Añade una línea poligonal para la ruta óptima (sin animación)
            const routeLine = L.polyline(waypoints, { color: 'blue' }).addTo(map);

            // Personaliza el ícono del bondi
            const busIcon = L.icon({
                iconUrl: 'bus.png', // Ícono de bondi
                iconSize: [40, 40], // Tamaño del ícono
                iconAnchor: [20, 40] // Centro del ícono
            });

            // Marcador para el bondi que se moverá a través de la ruta
            const travelerMarker = L.marker(waypoints[0], { icon: busIcon }).addTo(map);

            // Índice y función de animación
            let index = 0;

            function animateRoute() {
                if (index < waypoints.length - 1) {
                    // Obtiene el punto actual y el siguiente
                    const startPoint = waypoints[index];
                    const endPoint = waypoints[index + 1];

                    // Mueve el marcador del bondi con una animación entre puntos
                    moveMarker(travelerMarker, startPoint, endPoint, 1000, () => {
                        // Al llegar al punto, agrega un marcador de "visitado"
                        L.circleMarker(endPoint, {
                            radius: 6,
                            color: 'green',
                            fillColor: 'green',
                            fillOpacity: 0.8
                        }).bindPopup(`Visitado: ${endPoint}`).addTo(map);

                        index++;
                        animateRoute(); // Llama a la siguiente animación
                    });
                }
            }

            // Función para mover el marcador con una animación suave entre dos puntos
            function moveMarker(marker, start, end, duration, callback) {
                const startLatLng = L.latLng(start);
                const endLatLng = L.latLng(end);
                const steps = 50; // Cantidad de pasos en la animación
                const stepDuration = duration / steps;
                let step = 0;

                const move = setInterval(() => {
                    step++;
                    if (step > steps) {
                        clearInterval(move);
                        callback();
                    } else {
                        // Calcula la posición intermedia
                        const lat = startLatLng.lat + (endLatLng.lat - startLatLng.lat) * (step / steps);
                        const lng = startLatLng.lng + (endLatLng.lng - startLatLng.lng) * (step / steps);
                        marker.setLatLng([lat, lng]);
                    }
                }, stepDuration);
            }

            // Inicia la animación de la ruta
            animateRoute();
        });
    </script>
</body>

</html>
